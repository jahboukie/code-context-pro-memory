<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Payment Success - CodeContext Memory Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #0a0a0a; color: #fff; line-height: 1.6; }
    .container { max-width: 800px; margin: 0 auto; padding: 0 20px; }
    
    .header { background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 2rem 0; text-align: center; }
    .header h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 1rem; background: linear-gradient(135deg, #00f5ff, #ff0080); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    
    .success-content { padding: 4rem 0; text-align: center; }
    .success-icon { font-size: 4rem; margin-bottom: 2rem; }
    .success-title { font-size: 2rem; margin-bottom: 1rem; color: #00ff88; }
    .success-message { font-size: 1.2rem; margin-bottom: 2rem; opacity: 0.9; }
    
    .license-key { background: #1a1a1a; border: 2px solid #00f5ff; border-radius: 12px; padding: 2rem; margin: 2rem 0; }
    .license-key h3 { color: #00f5ff; margin-bottom: 1rem; }
    .license-key .key { font-family: 'Courier New', monospace; font-size: 1.5rem; background: #000; padding: 1rem; border-radius: 8px; margin: 1rem 0; word-break: break-all; }
    .license-key .copy-btn { background: #00f5ff; color: #000; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; margin-top: 1rem; }
    
    .status { background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 2rem; margin: 2rem 0; }
    .status.loading { border-color: #00f5ff; }
    .status.success { border-color: #00ff88; }
    .status.error { border-color: #ff0088; }
    
    .spinner { border: 4px solid #333; border-top: 4px solid #00f5ff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .cli-instructions { background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 2rem; margin: 2rem 0; text-align: left; }
    .cli-instructions h3 { color: #ff0080; margin-bottom: 1rem; }
    .cli-instructions .code { background: #000; padding: 1rem; border-radius: 8px; font-family: 'Courier New', monospace; margin: 1rem 0; }
    
    .btn { background: linear-gradient(135deg, #00f5ff, #ff0080); color: #fff; border: none; padding: 1rem 2rem; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-block; margin: 1rem 0; }
    .btn:hover { transform: translateY(-2px); }
  </style>
</head>
<body>
  <div class="header">
    <div class="container">
      <h1>üéâ Payment Successful!</h1>
      <p>Welcome to the AI Memory Revolution</p>
    </div>
  </div>

  <div class="container">
    <div class="success-content">
      <div class="success-icon">üß†</div>
      <h2 class="success-title">Your CodeContext Memory Pro License is Ready!</h2>
      <p class="success-message">Setting up your account and generating your license key...</p>
      
      <div id="status" class="status loading">
        <div class="spinner"></div>
        <p>Verifying payment and setting up your account...</p>
      </div>

      <div id="license-section" class="license-key" style="display: none;">
        <h3>Your License Key</h3>
        <div id="license-key" class="key"></div>
        <button class="copy-btn" onclick="copyLicenseKey()">Copy License Key</button>
        <p style="margin-top: 1rem; opacity: 0.8;">Save this key - you'll need it to activate your CLI!</p>
      </div>

      <div class="cli-instructions">
        <h3>üöÄ Next Steps: Activate Your CLI</h3>
        <div class="code">
          <div>npm install -g codecontext-memory</div>
          <div>codecontext activate <span id="user-email">your@email.com</span> <span id="cli-license-key">YOUR-LICENSE-KEY</span></div>
        </div>
      </div>

      <a href="/" class="btn">Return to Homepage</a>
    </div>
  </div>

  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBEWqJkxYJNPpAkLJ-7bTKvOkxGqPGLCnw",
      authDomain: "codecontext-memory-pro.firebaseapp.com",
      projectId: "codecontext-memory-pro",
      storageBucket: "codecontext-memory-pro.appspot.com",
      messagingSenderId: "565234567890",
      appId: "1:565234567890:web:abc123def456ghi789"
    };
    
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    let sessionId = null;
    let licenseKey = null;
    let userEmail = null;

    async function authenticateUser() {
      const urlParams = new URLSearchParams(window.location.search);
      sessionId = urlParams.get('session_id');
      const statusDiv = document.getElementById('status');
      
      if (!sessionId) {
        statusDiv.className = 'status error';
        statusDiv.innerHTML = '<p>‚ùå No session ID found. Please contact support if you completed a payment.</p>';
        return;
      }

      try {
        // Get license key first
        const licenseResponse = await fetch('/api/getLicenseKey', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId: sessionId })
        });

        if (!licenseResponse.ok) {
          throw new Error('Failed to get license key');
        }

        const licenseData = await licenseResponse.json();
        licenseKey = licenseData.licenseKey;
        userEmail = licenseData.email;

        // Show license key
        document.getElementById('license-key').textContent = licenseKey;
        document.getElementById('user-email').textContent = userEmail;
        document.getElementById('cli-license-key').textContent = licenseKey;
        document.getElementById('license-section').style.display = 'block';

        // Get authentication token
        const authResponse = await fetch('/api/getAuthToken', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId: sessionId })
        });

        if (!authResponse.ok) {
          throw new Error('Failed to get auth token');
        }

        const authData = await authResponse.json();
        
        // Sign in with custom token
        await auth.signInWithCustomToken(authData.customToken);
        
        statusDiv.className = 'status success';
        statusDiv.innerHTML = '<p>‚úÖ Successfully authenticated! You are now logged in.</p>';
        
        console.log('User authenticated:', auth.currentUser);
        
      } catch (error) {
        console.error('Authentication error:', error);
        statusDiv.className = 'status error';
        statusDiv.innerHTML = `<p>‚ùå Authentication failed: ${error.message}</p><p>Your license is still valid - you can activate it manually using the CLI.</p>`;
      }
    }

    function copyLicenseKey() {
      if (licenseKey) {
        navigator.clipboard.writeText(licenseKey).then(() => {
          const btn = document.querySelector('.copy-btn');
          const originalText = btn.textContent;
          btn.textContent = 'Copied!';
          setTimeout(() => {
            btn.textContent = originalText;
          }, 2000);
        });
      }
    }

    // Start authentication when page loads
    document.addEventListener('DOMContentLoaded', authenticateUser);
  </script>
</body>
</html>